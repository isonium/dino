{% extends 'index.html' %}

{% block content %}

<p>
    History
</p>

<div>
    <form id="search-history" method="post" action="{{ config.ROOT_URL }}history/search" class="pure-form">
        <fieldset>
             <legend>Show history for</legend>
            {{ render_field(form.room_id) }}
            {{ render_field(form.user_id) }}
            {{ render_field(form.from_time) }}
            {{ render_field(form.to_time) }}
            <br /><br />
            <p><input type="submit" value="Search" class="pure-button pure-button-primary" /></p>
        </fieldset>
    </form>
</div>

<div id="history-search-info">
    Limited to 500 messages per query, narrow your time window if you wish to see more. Max time window is 7 days. If
    chosen window is longer, then 7 days after "from timestamp" will be used as "to timestamp". If no "to timestamp" is
    chosen but a "from timestamp" is chosen, then "to timestamp" wil be set to <i>one hour after</i> "to timestamp".
    Similarly, if a "to timestamp" is chosen but no "from timestamp", then "from timestamp" will be set to <i>one
    hour before</i> "to timestamp". If neither "from timestamp" nor "to timestamp" is selected, "to timestamp" will be
    set to "now" and "from timestamp" set to <i>7 days</i> before now.<br /><br />
    See the "from" and "to" times below to know the real time window used in the query.
</div>

<hr />

<table id="real-history-time">
    <thead>
        <tr>
            <th>&nbsp;</th>
            <th><span class="time-header">Local time</span></th>
            <th><span class="time-header">UTC</span></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><span class="time-header">From</span></td>
            <td><span class="datetime">{{ real_from_time }}</span></td>
            <td><span>{{ real_from_time }}</span></td>
        </tr>
        <tr>
            <td><span class="time-header">To</span></td>
            <td><span class="datetime">{{ real_to_time }}</span></td>
            <td><span>{{ real_to_time }}</span></td>
        </tr>
    </tbody>
</table>
<br />

<table id="list-history" class="display responsive" cellspacing="0" width="100%">
    <thead>
        <tr>
            <td>
                From User (ID)
            </td>
            <td>
                Target
            </td>
            <td>
                Sent Time
            </td>
            <td>
                Content
            </td>
            <td>
                Type
            </td>
            <td>
                Deleted?
            </td>
        </tr>
    </thead>
    <tbody>
        {% for message in messages %}
        <tr>
            <td>
                {{ message.from_user_name }} <small>({{ message.from_user_id }})</small>
            </td>
            <td>
                {% if message.domain == 'room' %}
                    <a href="{{ config.ROOT_URL }}channel/{{ message.channel_id }}/room/{{ message.target_id }}">{{ message.target_name }}</a>
                {% else %}
                    {{ message.target_name }}
                {% endif %}
            </td>
            <td>
                <small>{{ message.timestamp }}</small>
            </td>
            <td>{{ message.body }}</td>
            <td>{{ message.domain }}</td>
            <td>
                <input class="message-id" type="hidden" value="{{ message.message_id }}" />
                {% if message.deleted == True %}
                    <input type="checkbox" name="message-deleted" checked>
                {% else %}
                    <input type="checkbox" name="message-deleted">
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<link rel="stylesheet" type="text/css" media="all" href="{{ config.ROOT_URL }}static/buttons.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="{{ config.ROOT_URL }}static/jquery.switchButton.css" />
<script type="text/javascript" src="{{ config.ROOT_URL }}static/jquery.switchButton.js"></script>
<script type="text/javascript" src="{{ config.ROOT_URL }}static/jszip.min.js"></script>
<script type="text/javascript" src="{{ config.ROOT_URL }}static/buttons.html5.min.js"></script>
<script type="text/javascript" src="{{ config.ROOT_URL }}static/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="{{ config.ROOT_URL }}static/custom/js/history.js"></script>

{% endblock %}
